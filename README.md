# HistoricalCurrencyVault

Этот репозиторий представляет собой демонстрационный проект по сбору и хранению исторических данных о курсах валют в PostgreSQL с использованием AirFlow. Данные берутся с сайта [Центрального Банка России (ЦБР)](https://cbr.ru/currency_base/daily/).

## Требования

- Установленный Docker.
- Установленный Astro CLI (для работы с AirFlow).

## Настройка PostgreSQL

База данных PostgreSQL разворачивается в виде контейнера Docker. Файл `docker-compose.yaml` разворачивает СУБД PostgreSQL и pgAdmin, который позволяет мониторить данные, хранящиеся в PostgreSQL. Файл `init.sql` при запуске `docker-compose` создаст внутри PostgreSQL таблицу финансов и схему финансов, а также модель данных из двух таблиц, которые будут заполняться на основе данных, взятых с сайта ЦБР.

### Шаги для развертывания PostgreSQL:

```bash
cd PostgreSQL
docker-compose up -d
```

### Доступ к pgAdmin:

После запуска, перейдите по ссылке [http://localhost:5430](http://localhost:5430) и используйте данные, указанные в файле `.env`, для входа в pgAdmin.

### Добавление инстанса PostgreSQL в pgAdmin:

1. Добавьте инстанс PostgreSQL в pgAdmin согласно данным из файла `.env`.
2. При указании хоста рекомендуется воспользоваться командой `ipconfig` для OS Windows и передать IP-адрес из раздела IPv4-адрес.

## Настройка AirFlow

Для работы с AirFlow используется Astro CLI. Для установки Astro CLI на OS Windows можно воспользоваться командой:

```bash
winget install -e --id Astronomer.Astro -v 1.28.1
```

### Шаги для настройки AirFlow:

1. Создайте директорию для AirFlow и инициализируйте проект:

```bash
mkdir AirFlow
cd AirFlow
astro dev init
```

2. Замените папку `dags` в созданном проекте на ту, что находится в корне проекта, а также замените файлы `requirements.txt` и `packages.txt`.

3. Запустите AirFlow:

```bash
astro dev start
```

4. После успешной сборки, перейдите по ссылке [http://localhost:8080](http://localhost:8080) и используйте `admin`/`admin` в качестве логина и пароля для входа в AirFlow.

5. Настройте подключение к PostgreSQL:

- Перейдите в раздел `Admin` -> `Connections` -> `Add new record`.
- Настройте подключение к PostgreSQL, используя те же данные, что и при подключении к pgAdmin.
- Наименование подключения необходимо задать как `postgres_conn`.

6. После сохранения подключения, запустите DAG `currency_rates_parser`. Он будет выгружать данные за период с 12.03.1993 по сегодняшний день. Просмотреть данные можно в pgAdmin.

### Отслеживание процесса выгрузки данных:

Для отслеживания процесса выгрузки данных перейдите в DAG `currency_rates_parser` и выберите вкладку "Calendar". Здесь вы сможете видеть историю запусков DAG и их статусы.

Собранные данные можно использовать для задач обучения каких-либо финансовых моделей или построения отчетности.
